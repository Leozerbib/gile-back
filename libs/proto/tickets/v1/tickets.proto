syntax = "proto3";

package tickets.v1;

import "profile/v1/profile.proto";
import "sprints/v1/sprints.proto";
import "labels/v1/labels.proto";
import "projects/v1/projects.proto";
import "util/search.proto";

option go_package = "github.com/bibz-project/gile-back/libs/proto/tickets/v1";

// ============================================================================
// REQUEST/RESPONSE MESSAGES
// ============================================================================
message CreateTicketRequest {
  string user_id = 1;
  CreateTicketDto dto = 2;
}

message SearchTicketsRequest {
  string user_id = 1;
  int32 project_id = 2;
  optional util.SearchQuery params = 3;
}

message SearchTicketsResponse {
  repeated TicketDto items = 1;
  int32 total = 2 [deprecated = true];
  int32 skip = 3 [deprecated = true];
  int32 take = 4 [deprecated = true];
  bool has_next = 5;
  bool has_prev = 6;
}

message GetTicketByIdRequest {
  string user_id = 1;
  int32 id = 2;
}

message UpdateTicketRequest {
  string user_id = 1;
  string id = 2;
  UpdateTicketDto dto = 3;
}

message DeleteTicketRequest {
  string user_id = 1;
  string id = 2;
}

message DeleteTicketResponse {
  bool success = 1;
}

// ============================================================================
// DTOs (aligned with libs/shared/types/src/tickets/dtos.ts)
// ============================================================================
message CreateTicketDto {
  string title = 1;
  string description = 2;
  string priority = 3; // e.g., LOW | MEDIUM | HIGH | CRITICAL
  string category = 4; // e.g., BUG | TASK | FEATURE
  int32 story_points = 5;
  float estimated_hours = 6;
  string due_date = 7;
  int32 project_id = 8;
  optional int32 sprint_id = 9;
  int32 parent_ticket_id = 10;
  repeated int32 task_ids = 11;
  repeated int32 label_ids = 12;
  repeated int32 dependency_ticket_ids = 13;
}

message UpdateTicketDto {
  string title = 1;
  string description = 2;
  string status = 3;
  string priority = 4;
  string category = 5;
  int32 story_points = 6;
  float estimated_hours = 7;
  float actual_hours = 8;
  string due_date = 9;
  string completed_at = 10;
  string implementation_notes = 11;
  string testing_notes = 12;
  optional int32 sprint_id = 13;
  string assigned_to = 14;
  string ticket_number = 15;
  int32 parent_ticket_id = 16;
  repeated int32 task_ids = 17;
  repeated int32 label_ids = 18;
  repeated int32 dependency_ticket_ids = 19;
}

message TicketDto {
  int32 id = 1;
  repeated int32 task_ids = 2;
  optional int32 sprint_id = 3;
  int32 project_id = 4;
  string assigned_to = 5;
  int32 parent_ticket_id = 6;
  string ticket_number = 7;
  string title = 8;
  string description = 9;
  string status = 10;
  string priority = 11;
  string category = 12;
  int32 story_points = 13;
  float estimated_hours = 14;
  float actual_hours = 15;
  string due_date = 16;
  string completed_at = 17;
  string implementation_notes = 18;
  string testing_notes = 19;
  string created_at = 20;
  string updated_at = 21;
  string created_by = 22;
  string updated_by = 23;
  projects.v1.ProjectOverview project = 24;
  sprints.v1.SprintOverview sprint = 25;
  profile.v1.ProfileOverview created_by_user = 26;
  profile.v1.ProfileOverview updated_by_user = 27;
  profile.v1.ProfileOverview assigned_to_user = 28;
  repeated labels.v1.LabelDto labels = 29;
  repeated int32 dependency_ticket_ids = 30;
}

// ============================================================================
// SERVICE
// ============================================================================
service Tickets {
  rpc Create(CreateTicketRequest) returns (TicketDto);
  rpc Search(SearchTicketsRequest) returns (SearchTicketsResponse);
  rpc GetById(GetTicketByIdRequest) returns (TicketDto);
  rpc Update(UpdateTicketRequest) returns (TicketDto);
  rpc Delete(DeleteTicketRequest) returns (DeleteTicketResponse);
}
